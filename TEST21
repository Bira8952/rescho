-- Beginn des vollständigen und korrigierten Skripts
local library = {
    windowcount = 0;
}

local dragger = {};
local resizer = {};

do
    local mouse = game:GetService("Players").LocalPlayer:GetMouse();
    local inputService = game:GetService('UserInputService');
    local heartbeat = game:GetService("RunService").Heartbeat;

    function dragger.new(frame)
        local s, event = pcall(function()
            return frame.MouseEnter
        end)

        if s then
            frame.Active = true;

            event:Connect(function()
                local input = frame.InputBegan:Connect(function(key)
                    if key.UserInputType == Enum.UserInputType.MouseButton1 or key.UserInputType == Enum.UserInputType.Touch then
                        local objectPosition = Vector2.new(mouse.X - frame.AbsolutePosition.X, mouse.Y - frame.AbsolutePosition.Y);
                        while heartbeat:Wait() and inputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton1) do
                            frame.Position = UDim2.new(0, mouse.X - objectPosition.X + (frame.Size.X.Offset * frame.AnchorPoint.X), 0, mouse.Y - objectPosition.Y + (frame.Size.Y.Offset * frame.AnchorPoint.Y))
                        end
                    end
                end)

                local leave;
                leave = frame.MouseLeave:Connect(function()
                    input:Disconnect();
                    leave:Disconnect();
                end)
            end)
        end
    end

    function resizer.new(p, s)
        p:GetPropertyChangedSignal('AbsoluteSize'):Connect(function()
            s.Size = UDim2.new(s.Size.X.Scale, s.Size.X.Offset, s.Size.Y.Scale, p.AbsoluteSize.Y);
        end)
    end
end

local defaults = {
    txtcolor = Color3.fromRGB(255, 255, 255),
    underline = Color3.fromRGB(0, 122, 204),
    barcolor = Color3.fromRGB(35, 35, 35),
    bgcolor = Color3.fromRGB(45, 45, 45),
    boxcolor = Color3.fromRGB(55, 55, 55),
    bartextcolor = Color3.fromRGB(255, 255, 255),
}

function library.Create(class, props)
    local object = Instance.new(class);

    for i, prop in next, props do
        if i ~= "Parent" then
            object[i] = prop;
        end
    end

    object.Parent = props.Parent;
    return object;
end

function library:CreateWindow(options)
    assert(options.text, "kein Name angegeben");
    local window = {
        count = 0;
        toggles = {},
        closed = false;
    }

    local options = options or {};
    setmetatable(options, {__index = defaults})

    self.windowcount = self.windowcount + 1;

    library.gui = library.gui or library.Create("ScreenGui", {Name = "UILibrary", Parent = game:GetService("CoreGui")})
    library.gui.ResetOnSpawn = false

    window.frame = library.Create("Frame", {
        Name = options.text;
        Parent = library.gui,
        Active = true,
        BackgroundTransparency = 0,
        Size = UDim2.new(0, 220, 0, 30),
        Position = UDim2.new(0, (15 + ((240 * self.windowcount) - 240)), 0, 15),
        BackgroundColor3 = options.barcolor,
        BorderSizePixel = 0;
        ClipsDescendants = false;
        ZIndex = 1;
    })

    library.Create('UICorner', {
        CornerRadius = UDim.new(0, 6),
        Parent = window.frame,
    })

    window.background = library.Create('Frame', {
        Name = 'Background';
        Parent = window.frame,
        BorderSizePixel = 0;
        BackgroundColor3 = options.bgcolor,
        Position = UDim2.new(0, 0, 1, 0),
        Size = UDim2.new(1, 0, 0, 25),
        ClipsDescendants = false;
        ZIndex = 1;
    })

    library.Create('UICorner', {
        CornerRadius = UDim.new(0, 6),
        Parent = window.background,
    })

    window.container = library.Create('Frame', {
        Name = 'Container';
        Parent = window.background,
        BorderSizePixel = 0;
        BackgroundTransparency = 1;
        Size = UDim2.new(1, 0, 1, 0),
        ClipsDescendants = false;
        ZIndex = 1;
    })

    window.organizer = library.Create('UIListLayout', {
        Name = 'Sorter';
        SortOrder = Enum.SortOrder.LayoutOrder;
        Padding = UDim.new(0, 5);
        Parent = window.container;
    })

    window.padder = library.Create('UIPadding', {
        Name = 'Padding';
        PaddingLeft = UDim.new(0, 10);
        PaddingTop = UDim.new(0, 10);
        Parent = window.container;
    })

    library.Create("Frame", {
        Name = 'Underline';
        Size = UDim2.new(1, 0, 0, 2),
        Position = UDim2.new(0, 0, 1, -2),
        BorderSizePixel = 0;
        BackgroundColor3 = options.underline;
        Parent = window.frame;
        ZIndex = 1;
    })

    -- Position der Buttons angepasst, um Platz für den Schließen-Button zu schaffen
    local togglebutton = library.Create("TextButton", {
        Name = 'Toggle';
        ZIndex = 2,
        BackgroundTransparency = 1;
        Position = UDim2.new(1, -60, 0, 0),
        Size = UDim2.new(0, 30, 1, 0),
        Text = "-",
        TextSize = 18,
        TextColor3 = options.txtcolor,
        Font = Enum.Font.GothamBold;
        Parent = window.frame,
    });

    togglebutton.MouseButton1Click:Connect(function()
        window.closed = not window.closed
        togglebutton.Text = (window.closed and "+" or "-")
        if window.closed then
            window:Resize(true, UDim2.new(1, 0, 0, 0))
        else
            window:Resize(true)
        end
    end)

    -- Schließen-Button hinzufügen
    local closebutton = library.Create("TextButton", {
        Name = 'Close';
        ZIndex = 2,
        BackgroundTransparency = 1;
        Position = UDim2.new(1, -30, 0, 0),
        Size = UDim2.new(0, 30, 1, 0),
        Text = "x",
        TextSize = 18,
        TextColor3 = options.txtcolor,
        Font = Enum.Font.GothamBold;
        Parent = window.frame,
    });

    closebutton.MouseButton1Click:Connect(function()
        window.frame:Destroy()
    end)

    library.Create("TextLabel", {
        Size = UDim2.new(1, -65, 1, 0), -- Angepasst für die beiden Buttons
        BackgroundTransparency = 1;
        BorderSizePixel = 0;
        TextColor3 = options.bartextcolor,
        TextSize = 18,
        Font = Enum.Font.GothamBold;
        Text = options.text or "Fenster",
        TextXAlignment = Enum.TextXAlignment.Left,
        Name = "Window",
        Parent = window.frame,
        ZIndex = 1;
    })

    do
        dragger.new(window.frame)
        resizer.new(window.background, window.container);
    end

    local function getSize()
        local ySize = 0;
        for i, object in next, window.container:GetChildren() do
            if (not object:IsA('UIListLayout')) and (not object:IsA('UIPadding')) then
                ySize = ySize + object.AbsoluteSize.Y + window.organizer.Padding.Offset
            end
        end
        return UDim2.new(1, 0, 0, ySize + 10)
    end

    function window:Resize(tween, change)
        local size = change or getSize()
        self.container.ClipsDescendants = false;

        if tween then
            self.background:TweenSize(size, "Out", "Sine", 0.5, true)
        else
            self.background.Size = size
        end
    end

    function window:AddDropdown(optionsList, callback)
        self.count = self.count + 1
        optionsList = optionsList or {}
        local default = optionsList[1] or ""

        callback = callback or function() end
        local dropdownOpen = false
        local modalOverlay

        local dropdown = library.Create("TextButton", {
            Size = UDim2.new(1, -10, 0, 25),
            BackgroundTransparency = 0,
            BackgroundColor3 = options.boxcolor,
            TextColor3 = options.txtcolor,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextSize = 16,
            Text = "  " .. default,
            Font = Enum.Font.Gotham,
            LayoutOrder = self.count,
            BorderSizePixel = 0,
            Parent = self.container,
            ZIndex = 1,
            ClipsDescendants = false,
            AutoButtonColor = false,
            Active = true,
        })

        library.Create('UICorner', {
            CornerRadius = UDim.new(0, 5),
            Parent = dropdown,
        })

        local arrow = library.Create("ImageLabel", {
            BackgroundTransparency = 1,
            Image = 'rbxassetid://7072718362',
            Size = UDim2.new(0, 16, 0, 16),
            Position = UDim2.new(1, -25, 0.5, -8),
            Parent = dropdown,
            ZIndex = 1,
        })

        local optionsFrame = library.Create('Frame', {
            Size = UDim2.new(0, dropdown.AbsoluteSize.X, 0, 0),
            Position = UDim2.new(0, dropdown.AbsolutePosition.X, 0, dropdown.AbsolutePosition.Y + dropdown.AbsoluteSize.Y),
            BackgroundTransparency = 0,
            BackgroundColor3 = options.boxcolor,
            BorderSizePixel = 0,
            Parent = nil,
            ClipsDescendants = false,
            ZIndex = 100,
            Active = true,
        })

        library.Create('UICorner', {
            CornerRadius = UDim.new(0, 5),
            Parent = optionsFrame,
        })

        local listLayout = library.Create('UIListLayout', {
            Parent = optionsFrame,
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 2),
        })

        local optionButtons = {}

        for i, option in ipairs(optionsList) do
            local optionButton = library.Create('TextButton', {
                Text = option,
                Size = UDim2.new(1, -4, 0, 25),
                Position = UDim2.new(0, 2, 0, 0),
                BackgroundTransparency = 0,
                BackgroundColor3 = options.boxcolor,
                TextColor3 = options.txtcolor,
                TextXAlignment = Enum.TextXAlignment.Left,
                TextSize = 16,
                Font = Enum.Font.Gotham,
                BorderSizePixel = 0,
                Parent = optionsFrame,
                ZIndex = 101,
                AutoButtonColor = false,
                Active = true,
            })

            optionButton.MouseButton1Click:Connect(function()
                dropdown.Text = "  " .. option
                callback(option)
                dropdownOpen = false
                optionsFrame.Visible = false
                optionsFrame.Parent = nil
                if modalOverlay then
                    modalOverlay:Destroy()
                end
            end)

            table.insert(optionButtons, optionButton)
        end

        optionsFrame.Visible = false

        dropdown.MouseButton1Click:Connect(function()
            dropdownOpen = not dropdownOpen
            if dropdownOpen then
                modalOverlay = library.Create('Frame', {
                    Size = UDim2.new(1, 0, 1, 0),
                    Position = UDim2.new(0, 0, 0, 0),
                    BackgroundTransparency = 1,
                    BackgroundColor3 = Color3.new(0, 0, 0),
                    BorderSizePixel = 0,
                    Parent = library.gui,
                    ZIndex = 99,
                    Active = true,
                })

                optionsFrame.Parent = modalOverlay
                optionsFrame.ZIndex = 100
                for _, child in ipairs(optionsFrame:GetChildren()) do
                    child.ZIndex = 101
                end

                optionsFrame.Visible = true
                optionsFrame.Size = UDim2.new(0, dropdown.AbsoluteSize.X, 0, listLayout.AbsoluteContentSize.Y)
                optionsFrame.Position = UDim2.new(0, dropdown.AbsolutePosition.X, 0, dropdown.AbsolutePosition.Y + dropdown.AbsoluteSize.Y)

                modalOverlay.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        local mousePos = game:GetService('UserInputService'):GetMouseLocation()
                        local withinOptions = (mousePos.X > optionsFrame.AbsolutePosition.X and mousePos.X < optionsFrame.AbsolutePosition.X + optionsFrame.AbsoluteSize.X) and
                            (mousePos.Y > optionsFrame.AbsolutePosition.Y and mousePos.Y < optionsFrame.AbsolutePosition.Y + optionsFrame.AbsoluteSize.Y)
                        if not withinOptions then
                            dropdownOpen = false
                            optionsFrame.Visible = false
                            optionsFrame.Parent = nil
                            modalOverlay:Destroy()
                        end
                    end
                end)
            else
                if modalOverlay then
                    optionsFrame.Visible = false
                    optionsFrame.Parent = nil
                    modalOverlay:Destroy()
                end
            end
        end)

        game:GetService("RunService").RenderStepped:Connect(function()
            if dropdownOpen and optionsFrame.Visible and dropdown.AbsolutePosition then
                optionsFrame.Position = UDim2.new(0, dropdown.AbsolutePosition.X, 0, dropdown.AbsolutePosition.Y + dropdown.AbsoluteSize.Y)
            end
        end)

        self:Resize()
        return dropdown
    end

    return window
end

return library
-- Ende des vollständigen und korrigierten Skripts
